# Claude Agent System - 完整流程复述

## 🎯 核心架构

基于 SamuelQZQ 实战验证的长时间运行 Agent 系统。

**必须有的核心文件：**
```
project-root/
├── CLAUDE.md          # ⭐ Agent 工作流程（强约束）
├── init.sh            # 🔧 初始化脚本（每次会话前运行）
├── task.json          # 📋 任务列表（单一真理来源）
├── progress.txt       # 📝 进度日志（Agent 自动填写）
├── PRD.md             # 📄 产品需求（你写）
├── architecture.md    # 🏗️ 架构设计（你写）
├── rules.md           # 📏 编码规范（强约束）
└── testing.md         # 🧪 测试规则（强约束）
```

---

## 🔄 全流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      阶段一：初始化对话（你和我对话）                      │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 1. 我问你：项目名称、描述、目标用户                                    │  │
│  │ 2. 我问你：核心功能有哪些（如果不详细我会追问）                            │  │
│  │ 3. 我问你：技术栈是什么                                             │  │
│  │ 4. 我复述理解：让我你确认我对项目的理解是否正确                      │  │
│  │ 5. 你确认 → 我生成所有约束文件                                      │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      阶段二：检查和修改文件                                 │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 你可以查看生成的文件：                                                   │  │
│  │ - cat PRD.md           # 查看产品需求                              │  │
│  │ - cat architecture.md  # 查看架构设计                              │  │
│  │ - cat task.json        # 查看任务列表                              │  │
│  │                                                                         │  │
│  │ 如果需要修改：                                                           │  │
│  │ - vim PRD.md           # 直接编辑                                   │  │
│  │ - vim task.json        # 添加/删除/修改任务                         │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      阶段三：环境初始化（每次开发会话）                       │
│                                                                         │
│  ./init.sh                                                              │
│   ├── 安装依赖                                                           │
│   ├── 启动开发服务器                                                     │
│   └── 显示服务器地址                                                     │
│                                                                         │
│  输出：                                                                   │
│  ✓ Dependencies installed                                              │
│  ✓ Dev server running at http://localhost:3000                        │
└─────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      阶段四：自动开发循环（重复直到完成）                   │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 每个会话：                                                            │  │
│  │                                                                         │  │
│  │ 1. ./init.sh                        # 启动服务器                     │  │
│  │                                                                         │  │
│  │2. 读 task.json                     # 选下一个 passes:false 任务        │  │
│ │   → grep -c '"passes": false' task.json                            │  │
│  │   → 选择 priority 最高、dependencies 满足的任务                │  │
│  │                                                                         │  │
│  │3. 实现功能                          # 按步骤实现                  │  │
│  │   → 读 task.json 中的 steps                                          │  │
│  │   → 遵守 rules.md 编码规范                                          │  │
│  │                                                                         │  │
│  │4. 测试验证                          # 分层测试                     │  │
│  │   → 大幅修改：浏览器测试 (Playwright)                                  │  │
│  │   → 小修改：npm run lint && npm run build                            │  │
│  │                                                                         │  │
│  │5. 更新 progress.txt                 # 记录工作                     │  │
│ │   → 写入：What was done, Testing, Notes                            │  │
│  │                                                                         │  │
│  │6. 更新 task.json                    # 标记完成                     │  │
│  │   → 只改 "passes": false → true                                       │  │
│  │   → ⚠️ 不能删除/编辑/重排任务                                          │  │
│  │                                                                         │  │
│  │7. git commit                        # 提交代码                     │  │
│  │   → git add .                                                      │  │
│  │   → git commit -m "[ID] [标题] - completed"                       │  │
│  │   → ⚠️ 代码 + progress.txt + task.json 必须一起提交                    │  │
│  │                                                                         │  │
│  │ 遇到困难 → 🚫 停止，找我求助                                         │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                        所有任务 passes: true
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      项目完成                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📋 必需文件的作用

### CLAUDE.md — Agent 工作流程（最重要）

**作用**：定义我必须严格遵守的工作流程

**核心内容**：
- STEP 1: 初始化环境 (`./init.sh`)
- STEP 2: 选择下一个任务（读 `task.json`）
- STEP 3: 实现功能
- STEP 4: 测试验证（分层测试规则）
- STEP 5: 更新 `progress.txt` 和 `task.json`
- STEP 6: Git 提交代码
- 🚫 阻塞处理机制

### task.json — 任务列表（单一真理来源）

**作用**：定义所有要完成的任务

**格式**：
```json
{
  "project": "项目名称",
  "tasks": [
    {
      "id": 1,
      "title": "任务标题",
      "description": "详细描述",
      "steps": ["步骤1", "步骤2", "步骤3"],
      "passes": false,        // ← 只能改这个字段
      "priority": "critical|high|medium|low",
      "dependencies": []  // ← 依赖的任务ID
    }
  ]
}
```

**重要规则**：
- ✅ 只能修改 `passes: false` → `passes: true`
- ❌ 不能删除任务
- ❌ 不能修改任务描述
- ❌ 不能修改步骤
- ❌ 不能重新排序

### progress.txt — 进度日志

**作用**：记录每个任务的完成情况

**格式**：
```markdown
## [日期] - Task: [任务标题]

### What was done:
- [具体修改]

### Testing:
- [测试方法和结果]

### Notes:
- [注意事项]
```

### init.sh — 初始化脚本

**作用**：每次开发会话前运行

**功能**：
- 安装依赖
- 启动开发服务器
- 显示服务器地址

### rules.md — 编码规范

**作用**：强约束编码规范

**包含**：
- 命名规范
- 代码风格
- 文件组织
- Git 规范
- 安全规范

### testing.md — 测试规则

**作用**：定义测试和验证标准

**分层测试**：
- 大幅修改 → 浏览器测试
- 小修改 → lint + build

---

## 🚫 阻塞处理（重要）

### 以下情况必须停止并找我求助

| 情况 | 示例 |
|------|------|
| 缺少环境配置 | `.env` 需要 API 密钥 |
| 外部服务不可用 | 第三方 API 宕机 |
| 测试无法进行 | 需要真实用户账号 |
| 需求不明确 | 文档描述不清楚 |

### 阻塞信息格式

```markdown
🚫 任务阻塞 - 需要人工介入

**当前任务**: [任务ID - 任务标题]

**已完成的工作**:
- [已完成部分]

**阻塞原因**:
- [具体原因]

**需要人工帮助**:
1. [步骤1]
2. [步骤2]
```

---

## 💬 现在开始

**请告诉我以下信息：**

**【基本信息】**
1. 项目叫什么名字？
2. 这个项目是做什么的？
3. 目标用户是谁？

**【核心功能】**
- 有哪些核心功能？（请简要说明，如果需要我会追问）

**【技术栈】**
- 前端用什么框架？
- 需要后端吗？需要数据库吗？

或者你有 PRD 文档可以直接给我。
